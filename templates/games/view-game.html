{% extends "base-nav/base-nav.html" %}

{% block scripts %}
    <!-- Your component JS -->
    <script src="{{ url_for("static", filename="js/components/games/view-game.js") }}"></script>
{% endblock %}

{% block content %}
    <div x-data="viewGameApp" class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8 px-4 sm:px-6 lg:px-8">
        <input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="max-w-7xl mx-auto space-y-8">

            <!-- 1) Update Form (Coach/Admin only) -->
            {% if g.user_profile.user.role.value in ["admin", "coach"] %}
                <section class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Update Game Details</h2>
                    <form id="update-form" @submit.prevent="submitUpdate" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="final_score" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Final Score</label>
                            <input id="final_score" name="final_score" type="text"
                                   x-model="formFinalScore"
                                   class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 text-lg p-2"/>
                        </div>
                        <div class="md:col-span-2">
                            <label for="video_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Video URL</label>
                            <input id="video_url" name="video_url" type="url"
                                   x-model="formVideoUrl"
                                   class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 text-lg p-2"/>
                        </div>
                        <div class="md:col-span-3 flex items-center gap-3">
                            <button type="submit"
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition disabled:opacity-50 disabled:cursor-not-allowed"
                                    :disabled="updating">
                                <span x-text="updateButtonText"></span>
                            </button>
                            <p class="text-sm text-gray-500" x-text="updateStatusText"></p>
                        </div>
                    </form>
                </section>
            {% endif %}

            <!-- 2) Embedded Video -->
            <section class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Match Video</h2>
                <div x-show="hasVideo" class="w-full max-w-4xl mx-auto">
                    <div class="relative pb-[56.25%] h-0 overflow-hidden rounded-lg shadow">
                        <iframe class="absolute top-0 left-0 w-full h-full"
                                allowfullscreen loading="lazy" referrerpolicy="no-referrer"
                                :src="embedVideoUrl"></iframe>
                    </div>
                </div>
                <div x-show="!hasVideo" class="text-gray-500 dark:text-gray-400">
                    No video URL set.
                </div>
            </section>


            <!-- 3) Interactive Stats Form -->
            <section class="bg-white dark:bg-gray-800 rounded-lg shadow p-6" x-show="latestGameData" x-cloak>
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Placeholder InteractiveForm</h2>

            </section>


            <!-- 4) Readonly Stats Viewer -->
            <section class="bg-white dark:bg-gray-800 rounded-lg shadow p-6" x-show="latestGameData" x-cloak>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Statistics</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-300" x-text="currentSetScoreText"></p>
                </div>

                <!-- Tabs -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <template x-for="(label, idx) in setLabels" :key="idx">
                        <button type="button"
                                :class="activeSetIndex === idx ? 'px-3 py-1 rounded bg-indigo-600 text-white'
                                           : 'px-3 py-1 rounded bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300'"
                                @click="activeSetIndex = idx">
                            <span x-text="label"></span>
                        </button>
                    </template>

                    <div class="w-px h-6 bg-gray-300 dark:bg-gray-700 mx-1"></div>

                    <template x-for="team in teams" :key="team.key">
                        <button type="button"
                                :class="activeTeamKey===team.key ? 'px-3 py-1 rounded bg-indigo-600 text-white'
                                             : 'px-3 py-1 rounded bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300'"
                                @click="activeTeamKey=team.key">
                            <span x-text="team.label"></span>
                        </button>
                    </template>
                </div>

                <!-- Stats Table -->
                <div class="overflow-x-auto">
                    <div x-show="getCurrentStatsEntries().length === 0"
                         class="text-gray-500 dark:text-gray-400">
                        No stats available for the selected set/team.
                    </div>
                    <table x-show="getCurrentStatsEntries().length > 0"
                           class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-2">Player #</th>
                            <th class="px-4 py-2">Kills</th>
                            <th class="px-4 py-2">Sets</th>
                            <th class="px-4 py-2">Blocks</th>
                            <th class="px-4 py-2">Digs</th>
                            <th class="px-4 py-2">Aces</th>
                            <th class="px-4 py-2">Missed Serves</th>
                            <th class="px-4 py-2">Errors</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template x-for="[num, stats] in getCurrentStatsEntries()" :key="num">
                            <tr>
                                <td class="px-4 py-2" x-text="num"></td>
                                <td class="px-4 py-2" x-text="stats.kills"></td>
                                <td class="px-4 py-2" x-text="stats.setsCount"></td>
                                <td class="px-4 py-2" x-text="stats.blocks"></td>
                                <td class="px-4 py-2" x-text="stats.digs"></td>
                                <td class="px-4 py-2" x-text="stats.aces"></td>
                                <td class="px-4 py-2" x-text="stats.missed_serves"></td>
                                <td class="px-4 py-2" x-text="stats.errors"></td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                </div>
            </section>

        </div>
    </div>
{% endblock %}
